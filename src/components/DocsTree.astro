---
import { getCollection } from 'astro:content';

// docsLoader id format: 'docs/subcategory/slug' for docs, 'docs/subcategory' for index pages

// Subcategories that have at least one doc (= migrated)
const allDocs = await getCollection('docs', ({ id }) => {
  const parts = id.split('/');
  return parts[0] === 'docs' && parts.length >= 3;
});

const migratedSubcategories = new Set(
  allDocs.map(doc => doc.id.split('/')[1])
);

// Subcategories that have an index page: id is exactly 'docs/subcategory' (2 parts)
const indexPages = await getCollection('docs', ({ id }) => {
  const parts = id.split('/');
  return parts.length === 2 && parts[0] === 'docs';
});

const subcategoriesWithIndex = new Set(indexPages.map(p => p.id.split('/')[1]));

const groups = [
  { label: 'Computer Science', items: [
    { key: 'computer-architecture', label: 'Computer Architecture' },
    { key: 'operating-system', label: 'Operating System' },
    { key: 'network', label: 'Network' },
    { key: 'secure', label: 'Secure' },
  ]},
  { label: 'Database', items: [
    { key: 'mysql', label: 'MySQL' },
    { key: 'redis', label: 'Redis' },
  ]},
  { label: 'Language', items: [
    { key: 'java', label: 'Java' },
  ]},
  { label: 'Framework', items: [
    { key: 'spring', label: 'Spring' },
  ]},
  { label: 'Messaging & Streaming', items: [
    { key: 'kafka', label: 'Kafka' },
  ]},
  { label: 'Software Engineering', items: [
    { key: 'test', label: 'Test' },
    { key: 'ai-assisted-development', label: 'AI-Assisted Development' },
  ]},
  { label: 'DevOps & Infra', items: [
    { key: 'docker', label: 'Docker' },
  ]},
  { label: 'System Architecture', items: [
    { key: 'large-scale-system', label: 'Large-Scale System' },
  ]},
  { label: 'Design Pattern', items: [
    { key: 'oop', label: 'OOP' },
  ]},
  { label: 'ETC', items: [
    { key: 'setting', label: 'Setting' },
  ]},
];

const visibleGroups = groups.map(group => ({
  ...group,
  items: group.items.filter(item => migratedSubcategories.has(item.key)),
})).filter(group => group.items.length > 0);
---

<div class="docs-tree">
  {visibleGroups.length === 0 ? (
    <p class="empty-state">문서가 없습니다.</p>
  ) : visibleGroups.map(group => (
    <div class="group-section">
      <h2 class="group-title">{group.label}</h2>
      <ul class="item-list">
        {group.items.map(item => (
          <li>
            {subcategoriesWithIndex.has(item.key)
              ? <a href={`/docs/${item.key}/`} class="item-link">{item.label}</a>
              : <span class="item-link">{item.label}</span>
            }
          </li>
        ))}
      </ul>
    </div>
  ))}
</div>

<style>
  .docs-tree {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    padding: 1rem 0;
  }

  .group-section {
    border: 1px solid var(--sl-color-hairline);
    border-radius: 8px;
    padding: 1.25rem 1.5rem;
    background: var(--sl-color-bg-nav);
  }

  .group-title {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--sl-color-gray-3);
    margin: 0 0 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--sl-color-hairline);
  }

  .item-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }

  .item-link {
    font-size: 0.9rem;
    display: block;
    padding: 0.2rem 0;
    text-decoration: none;
    color: var(--sl-color-text);
    transition: color 0.15s;
  }

  a.item-link:hover {
    color: var(--sl-color-text-accent);
    text-decoration: underline;
  }

  .empty-state {
    color: var(--sl-color-gray-3);
    font-size: 0.9rem;
  }
</style>
